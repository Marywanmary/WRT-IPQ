name: Release-IPQ60XX-CZ

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: 0 16 * * 4

env:
  TZ: Asia/Shanghai
  FIRMWARE_PATTERN: "qualcommax-ipq60xx"
  MANIFEST_FILE: "*.manifest"
  APK_PATTERN: "*.apk"
  KERNEL_VERSION: "6.12"
  DEFAULT_IP: "192.168.2.1"
  DEFAULT_PASSWORD: "none"
  # ä½¿ç”¨|ä½œä¸ºåˆ†éš”ç¬¦ï¼Œé¿å…ä¸URLä¸­çš„å†’å·å†²çª
  REPO_MAP: |
    immwrt|https://github.com/laipeng668/immortalwrt.git|master|immwrt
    openwrt|https://github.com/laipeng668/openwrt.git|master|openwrt
    libwrt|https://github.com/laipeng668/openwrt-6.x.git|k6.12-nss|libwrt
  # ä¿®æ”¹é…ç½®æ–‡ä»¶è·¯å¾„ä¸ºdeconfigç›®å½•
  CONFIG_MAP: |
    Pro|deconfig/Pro.config
    Max|deconfig/Max.config
    Ultra|deconfig/Ultra.config
  # åŸºç¡€é…ç½®æ–‡ä»¶è·¯å¾„
  GENERAL_CONFIG: "deconfig/General.config"
  BASE_CONFIG: "deconfig/IPQ60XX.config"
  LIBWRT_CONFIG: "deconfig/Libwrt.config"

jobs:
  Build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        device: [
          "ipq60xx_immwrt_Pro",
          "ipq60xx_immwrt_Max", 
          "ipq60xx_immwrt_Ultra",
          "ipq60xx_openwrt_Pro",
          "ipq60xx_openwrt_Max",
          "ipq60xx_openwrt_Ultra",
          "ipq60xx_libwrt_Pro",
          "ipq60xx_libwrt_Max",
          "ipq60xx_libwrt_Ultra"
        ]

    steps:
    - name: Checkout(æ£€å‡ºä»£ç )
      uses: actions/checkout@main

    - name: Initialization Environment(åˆå§‹åŒ–ç¯å¢ƒ)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        set -euxo pipefail
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"

    - name: Check Server Performance(æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½)
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        echo -e "$(sudo lshw -short -C memory | grep GiB)"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Parse Device Info(è§£æè®¾å¤‡ä¿¡æ¯)
      id: parse
      run: |
        set -euxo pipefail
        
        # è§£æè®¾å¤‡åç§°
        CHIP=$(echo "${{ matrix.device }}" | cut -d'_' -f1)
        BRANCH_ABBR=$(echo "${{ matrix.device }}" | cut -d'_' -f2)
        CONFIG_TYPE=$(echo "${{ matrix.device }}" | cut -d'_' -f3)
        
        # è·å–ä»“åº“ä¿¡æ¯ - ä½¿ç”¨|ä½œä¸ºåˆ†éš”ç¬¦
        REPO_LINE=$(echo "${{ env.REPO_MAP }}" | grep "^$BRANCH_ABBR|")
        REPO_URL=$(echo "$REPO_LINE" | cut -d'|' -f2)
        REPO_BRANCH=$(echo "$REPO_LINE" | cut -d'|' -f3)
        BRANCH_PREFIX=$(echo "$REPO_LINE" | cut -d'|' -f4)
        
        # è·å–é…ç½®æ–‡ä»¶ - ä½¿ç”¨|ä½œä¸ºåˆ†éš”ç¬¦
        CONFIG_LINE=$(echo "${{ env.CONFIG_MAP }}" | grep "^$CONFIG_TYPE|")
        CONFIG_FILE=$(echo "$CONFIG_LINE" | cut -d'|' -f2)
        
        # è®¾ç½®é…ç½®æ–‡ä»¶ç»„åˆ - ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„è·¯å¾„
        CONFIG_FILES="${{ env.GENERAL_CONFIG }} ${{ env.BASE_CONFIG }} $CONFIG_FILE"
        
        # å¦‚æœæ˜¯libwrtåˆ†æ”¯ï¼Œæ·»åŠ Libwrt.config
        if [ "$BRANCH_ABBR" = "libwrt" ]; then
          CONFIG_FILES="$CONFIG_FILES ${{ env.LIBWRT_CONFIG }}"
        fi
        
        # è®¾ç½®å…¶ä»–å˜é‡
        DEVICE_PREFIX="${CHIP}-${BRANCH_ABBR}-${CONFIG_TYPE}"
        FIRMWARE_TAG="IPQ60XX-${{ matrix.device }}"
        
        # è¾“å‡ºå˜é‡
        echo "CHIP=$CHIP" >> $GITHUB_OUTPUT
        echo "BRANCH_ABBR=$BRANCH_ABBR" >> $GITHUB_OUTPUT
        echo "CONFIG_TYPE=$CONFIG_TYPE" >> $GITHUB_OUTPUT
        echo "REPO_URL=$REPO_URL" >> $GITHUB_OUTPUT
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_OUTPUT
        echo "BRANCH_PREFIX=$BRANCH_PREFIX" >> $GITHUB_OUTPUT
        echo "CONFIG_FILES=$CONFIG_FILES" >> $GITHUB_OUTPUT
        echo "DEVICE_PREFIX=$DEVICE_PREFIX" >> $GITHUB_OUTPUT
        echo "FIRMWARE_TAG=$FIRMWARE_TAG" >> $GITHUB_OUTPUT

    - name: Clone Source Code(å…‹éš†æºä»£ç )
      run: |
        set -euxo pipefail
        df -hT $GITHUB_WORKSPACE
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b "${{ steps.parse.outputs.REPO_BRANCH }}" --single-branch "${{ steps.parse.outputs.REPO_URL }}" /mnt/openwrt
        cd /mnt/openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-${{ env.KERNEL_VERSION }})
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: Generate Variables(ç”Ÿæˆå˜é‡)
      run: |
        set -euxo pipefail
        # åˆå¹¶é…ç½®æ–‡ä»¶
        cat ${{ steps.parse.outputs.CONFIG_FILES }} > $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1
        SOURCE_REPO="$(echo ${{ steps.parse.outputs.REPO_URL }} | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        echo "HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

    - name: Cache Toolchain(ç¼“å­˜å·¥å…·é“¾)
      uses: actions/cache@main
      with:
        key: ${{ env.SOURCE_REPO }}-${{ env.HASH }}-${{ matrix.device }} ${{ env.CACHE_DATE }}
        restore-keys: |
          ${{ env.SOURCE_REPO }}-${{ env.HASH }}-${{ matrix.device }}-
          ${{ env.SOURCE_REPO }}-${{ env.HASH }}-
          ${{ env.SOURCE_REPO }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: Refresh The Cache(åˆ·æ–°ç¼“å­˜)
      run: |
        set -euxo pipefail
        if [ -d "$OPENWRT_PATH/staging_dir" ]; then
          find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
          done
        fi

    - name: Install Feeds(å®‰è£…feeds)
      run: |
        set -euxo pipefail
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a
  
    - name: Load Custom Configuration(åŠ è½½è‡ªå®šä¹‰é…ç½®)
      run: |
        set -euxo pipefail
        chmod +x scripts/script.sh
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/scripts/script.sh

    - name: Download DL Package(ä¸‹è½½DLè½¯ä»¶åŒ…)
      run: |
        set -euxo pipefail
        cat ${{ steps.parse.outputs.CONFIG_FILES }} > $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig
        make download -j$(nproc)

    - name: Compile Firmware(å¼€å§‹ç¼–è¯‘å›ºä»¶)
      id: compile
      run: |
        set -euxo pipefail
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Check Space Usage(æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ)
      if: (!cancelled())
      run: df -hT

    - name: Organize Files(æ•´ç†æ–‡ä»¶)
      if: steps.compile.outputs.status == 'success'
      run: |
        set -euxo pipefail
        cd $OPENWRT_PATH/bin/targets/*/*
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        OUTPUT_DIR="$GITHUB_WORKSPACE/output_${{ matrix.device }}"
        mkdir -p $OUTPUT_DIR
        
        # å¤åˆ¶å¹¶é‡å‘½åé…ç½®æ–‡ä»¶
        cp $OPENWRT_PATH/.config $OUTPUT_DIR/${{ steps.parse.outputs.DEVICE_PREFIX }}.config
        cp config.buildinfo $OUTPUT_DIR/${{ steps.parse.outputs.DEVICE_PREFIX }}.config.buildinfo
        
        # å¤åˆ¶manifestæ–‡ä»¶
        for manifest_file in ${{ env.MANIFEST_FILE }}; do
          if [ -f "$manifest_file" ]; then
            cp "$manifest_file" $OUTPUT_DIR/${{ steps.parse.outputs.DEVICE_PREFIX }}.manifest
            break
          fi
        done
        
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *.bin; do
          # è·³è¿‡éç›®æ ‡æ–‡ä»¶
          [[ "$file" =~ factory|sysupgrade ]] || continue
          
          # æå–å›ºä»¶æ¨¡å¼
          MODE=$(echo "$file" | grep -oE "factory|sysupgrade")
          
          # æå–å›ºä»¶å‹å·
          if [[ "$file" =~ ${{ env.FIRMWARE_PATTERN }}-([^-]+)-squashfs ]]; then
            MODEL="${BASH_REMATCH[1]}"
          else
            MODEL="unknown-model"
          fi
          
          # æ–°æ–‡ä»¶åæ ¼å¼: åˆ†æ”¯ç¼©å†™-å›ºä»¶å‹å·-å›ºä»¶æ¨¡å¼-é…ç½®.bin
          NEW_FILE="${{ steps.parse.outputs.BRANCH_PREFIX }}-${MODEL}-${MODE}-${{ steps.parse.outputs.CONFIG_TYPE }}.bin"
          cp "$file" "$OUTPUT_DIR/$NEW_FILE"
        done
        
        # å¤åˆ¶å¹¶æ‰“åŒ…è½¯ä»¶åŒ…
        mkdir -p $OUTPUT_DIR/packages
        find $OPENWRT_PATH/bin/packages -name "${{ env.APK_PATTERN }}" -exec cp {} $OUTPUT_DIR/packages/ \;
        cd $OUTPUT_DIR
        tar -zcf ${{ steps.parse.outputs.DEVICE_PREFIX }}.Packages.tar.gz packages
        
        echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV

    - name: Upload Firmware To Artifact(å°†å›ºä»¶ä¸Šä¼ åˆ°Artifact)
      if: steps.compile.outputs.status == 'success'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-firmware-${{ matrix.device }}-${{ env.FILE_DATE }}
        path: ${{ env.OUTPUT_DIR }}

    - name: Delete Old Cache(åˆ é™¤æ—§ç¼“å­˜)
      run: |
        set -euxo pipefail
        # è·å–ç¼“å­˜åˆ—è¡¨å¹¶åˆ é™¤
        gh cache list --key ${{ env.SOURCE_REPO }}-${{ env.HASH }}-${{ matrix.device }} --json key --jq '.[] | .key' | while read -r key; do
          gh cache delete "$key"
        done
        # è¾“å‡ºç¼“å­˜çŠ¶æ€
        echo "========cache status========"
        echo "ccache: $(du -sh $OPENWRT_PATH/.ccache | cut -f 1)"
        echo "staging: $(du -sh $OPENWRT_PATH/staging_dir | cut -f 1)"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  Release:
    needs: Build
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
    - name: Checkout(æ£€å‡ºä»£ç )
      uses: actions/checkout@main

    - name: Download All Artifacts(ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©)
      uses: actions/download-artifact@main
      with:
        path: artifacts

    - name: Organize Release Files(æ•´ç†å‘å¸ƒæ–‡ä»¶)
      run: |
        set -euxo pipefail
        mkdir -p release_files
        cd artifacts
        
        # éå†æ‰€æœ‰è®¾å¤‡ç›®å½•
        for device_dir in */; do
          [ -d "$device_dir" ] && cp -r "$device_dir"* ../release_files/
        done
        
        cd ..
        echo "RELEASE_PATH=$(pwd)/release_files" >> $GITHUB_ENV
        echo "RELEASE_DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

    - name: Upload Firmware To Release(å‘å¸ƒå›ºä»¶)
      uses: ncipollo/release-action@main
      with:
        name: ${{ env.RELEASE_DATE }} for IPQ60XX-Multi
        allowUpdates: true
        tag: IPQ60XX-Multi
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.RELEASE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for IPQ60XX Multi-Devices**
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - è¿™æ˜¯å¼€å¯å…¨åŠŸèƒ½NSSçš„${{ env.KERNEL_VERSION }}å†…æ ¸å›ºä»¶ï¼Œé»˜è®¤ä¸»é¢˜ä¸ºArgonï¼›è¯¥å›ºä»¶åœ¨ImmortalWrtçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†é¢å¤–çš„è½¯ä»¶åŒ…cpufreqã€ddnsã€ttydã€upnpã€wolplusã€samba4ã€vlmcsdã€aria2ã€autorebootã€uhttpdã€wifischeduleã€frpsã€frpcã€diskmanã€hd-idleã€banipã€acmeã€arpbindã€usb-printerã€homeproxyã€openlistã€adguardhomeã€oafã€sqmã€wireguardã€watchcatã€3catï¼ˆ**Taiyi**é¢å¤–å¢åŠ äº†filebrowserã€dockermanã€gecoosacã€luckyï¼‰ï¼Œå¹¶æ·»åŠ äº†è‹¥å¹²å·¥å…·ï¼Œå…·ä½“è¯¦è§å¯¹åº”æœºå‹çš„configã€‚
          - ğŸ’» è¿™æ˜¯ IPQ60XX å¹³å°ä½¿ç”¨çš„ OpenWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : 
            - immwrt: https://github.com/laipeng668/immortalwrt.git (master)
            - openwrt: https://github.com/laipeng668/openwrt.git (master)
            - libwrt: https://github.com/laipeng668/openwrt-6.x.git (k6.12-nss)
          - ğŸŒ é»˜è®¤åœ°å€: **${{ env.DEFAULT_IP }}**
          - ğŸ”‘ é»˜è®¤å¯†ç : ${{ env.DEFAULT_PASSWORD }}
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.KERNEL_VERSION }}**
          - åŒ…å«è®¾å¤‡: 
            - ipq60xx_immwrt_Pro/Max/Ultra
            - ipq60xx_openwrt_Pro/Max/Ultra
            - ipq60xx_libwrt_Pro/Max/Ultra
          - å›ºä»¶å‘½åè§„åˆ™: åˆ†æ”¯ç¼©å†™-å›ºä»¶å‹å·-å›ºä»¶æ¨¡å¼-é…ç½®.bin
          ### ğŸ“¦ æ–‡ä»¶è¯´æ˜
          - å›ºä»¶æ–‡ä»¶: åˆ†æ”¯ç¼©å†™-å›ºä»¶å‹å·-å›ºä»¶æ¨¡å¼-é…ç½®.bin
          - é…ç½®æ–‡ä»¶: ipq60xx-åˆ†æ”¯ç¼©å†™-é…ç½®ç±»å‹.config
          - æ„å»ºä¿¡æ¯: ipq60xx-åˆ†æ”¯ç¼©å†™-é…ç½®ç±»å‹.config.buildinfo
          - è½¯ä»¶åŒ…æ¸…å•: ipq60xx-åˆ†æ”¯ç¼©å†™-é…ç½®ç±»å‹.manifest
          - è½¯ä»¶åŒ…å½’æ¡£: ipq60xx-åˆ†æ”¯ç¼©å†™-é…ç½®ç±»å‹.Packages.tar.gz
